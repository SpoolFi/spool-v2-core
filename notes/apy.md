# Strategy APY

The strategy registry is tracking the APY for each strategy. The APY is initially set when registering the strategy and is then updated on each DHW.

## Units

The APY is measured as integer value, such that APY of `100%` is `10^12` or `1000000000000`.

## Initial APY

When registering a strategy, an initial APY for that strategy needs to be provided. This APY is usually obtained from the UI or API of the protocol which the strategy is integrating.

## Updates to the APY

The APY for the strategy is updated on every DHW run for that strategy with the yield generated by the protocol. The yield is always calculated for the period between last DHW and current DHW. The strategy is calculating two types of yield:

- base yield and
- compound yield

The base yield usually measures the appreciation of the position held in the protocol, e.g., increase of the virtual price of the receipt tokens compared to the underlying token. The base yield can in principle be negative. Some strategies are able to calculate their base yield based on on-chain data at the DHW time. However, this is not always feasible, either due to gas costs, unavailability of correct data on-chain, or calculating the yield on-chain would open possible attack vectors against the strategy. For such strategies, the DHW-er must calculate the yield off-chain and provide it as a DHW parameter.

The compound yield usually measures the increase of position due to strategy claiming and reinvesting rewards given by the underlying protocol. Not all protocols offer such rewards.

Base and compound yields are combined into a total yield using the following formula:

$$ y_t = y_b + y_c + y_b \cdot y_c $$

This total yield is then used to update the APY of the strategy.

The DHW yield covers the period between previous and current DHW, or $t_\Delta$ measured in seconds. The corresponding APY can be calculated as:

$$ APY_{DHW} = y_t \cdot t_{year} / t_\Delta $$

Where $t_{year}$ is number of seconds in an average year.

This APY is then combined with the previous APY to calculate the new APY as:

$$ APY = APY_{DHW} \cdot w(t_\Delta) + APY_{old} \cdot (1 - w(t_Delta)) $$

where $w(t)$ is a running average weight, whose value depends on time elapsed since last DHW. It has a cutoff of 1 week, after which its value is `1` and only the $APY_{DHW}$ counts. For value of $w(t)$ we are using the following lookup table:

| $t$        | $w(t)$     |
| ---------- | ---------- |
| < 4h       | $ 0.0415 $ |
| < 12h      | $ 0.1244 $ |
| < 1 day    | $ 0.2449 $ |
| < 1.5 days | $ 0.3584 $ |
| < 2 days   | $ 0.4621 $ |
| < 3 days   | $ 0.6351 $ |
| < 4 days   | $ 0.7616 $ |
| < 5 days   | $ 0.8483 $ |
| < 6 days   | $ 0.9051 $ |
| < 1 week   | $ 0.9414 $ |
| > 1 week   | $ 1.0000 $ |

### First DHW

The value of APY is updated after each DHW, except for the first DHW. When performing the first DHW for a strategy, its APY is not updated. Up to the first DHW, the strategy has no stake in the protocol, so the yield is in some cases hard to define. And there are some additional issues due to internal implementation details. So when first DHW is performed, the APY is not updated for the strategy and it remains the same as was set on registration of the strategy.

The second DHW for a strategy and all following DHWs, use the procedure describe above to update the APY.

## Technical details

Immediately after deploying or even during deployment of a strategy it should be initialized. When initializing a strategy that can calculate yield from on-chain data, initial values of key parameters used calculate the yield are stored, e.g., virtual price of the receipt tokens. These parameters are then updated on each DHW.

When registering a strategy, a dummy DHW state for index 0 is created and populated with timestamp of the registration. The current DHW index for the strategy is set to 1, and this value is used as DHW index on first real DHW. When registering the strategy, the APY of the strategy needs to be provided, which is then used as an initial value for the strategy's APY.

Now, since initialization and registration do not happen at the same time, a wrong APY could be calculated on first DHW. The yield would be calculated for a period from initialization of the strategy to the DHW. However, the time delta used to calculate the APY from the yield would be from registration of the strategy to the DHW. This scenario is currently prevented by not updating the APY on the first DHW, with downside being that the APY is stale until the second DHW, at which point it starts being updated.
